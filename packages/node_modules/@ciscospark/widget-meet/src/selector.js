import {createSelector} from 'reselect';

const getWidget = (state) => state.widgetMeet;
const getMedia = (state) => state.media;
const getSparkInstance = (state, props) => props.sparkInstance || state.spark.get(`spark`);
const getSparkState = (state) => state.spark.get(`status`);
const getConversation = (state) => state.conversation;
const getAvatars = (state) => state.avatar;
const getUsers = (state) => state.user;
const getMercury = (state) => state.mercury;


const getCall = createSelector(
  [getConversation, getMedia],
  (conversation, media) => media.getIn([`calls`, conversation.get(`locusUrl`)])
);


export const getMeetWidgetProps = createSelector(
  [
    getSparkState,
    getSparkInstance,
    getAvatars,
    getConversation,
    getMercury,
    getMedia,
    getUsers,
    getWidget,
    getCall
  ],
  (sparkState, sparkInstance, avatars, conversation, mercury, media, users, widgetMeet, call) => { // eslint-disable-line max-params
    let avatarImage, displayName;
    const conversationId = conversation.get(`id`);
    if (conversationId) {
      avatarImage = avatars.getIn([`items`, conversationId]);
      displayName = conversation.get(`displayName`);
      const currentUserEmail = users.get(`currentUser`).email;

      // Need better way to store this in a single place
      if (conversation.get(`tags`).includes(`ONE_ON_ONE`)) {
        const toUser = conversation.get(`participants`)
          .filter((p) => p.get(`emailAddress`) !== currentUserEmail).first();
        displayName = toUser.get(`displayName`);
        avatarImage = avatars.getIn([`items`, toUser.get(`id`)]);
      }
    }

    const isWebRTCSupported = media.getIn([`webRTC`, `isSupported`]);

    let callIsActive, callIsIncoming, callIsRinging, callState;
    if (call) {
      callState = call.get(`callState`).toJS();
      // Is the call active?
      const {
        direction,
        connected,
        ringing,
        initiated,
        joinedOnThisDevice
      } = callState;

      callIsRinging = ringing;
      callIsActive = connected && joinedOnThisDevice || direction === `out`;
      callIsIncoming = direction === `in` && initiated && !joinedOnThisDevice;
    }

    return { // eslint-disable-line max-params
      avatarImage,
      call,
      callIsActive,
      callIsIncoming,
      callIsRinging,
      callState,
      conversation,
      displayName,
      isWebRTCSupported,
      locusUrl: conversation.get(`locusUrl`),
      media,
      mercury,
      sparkInstance,
      sparkState: sparkState.toJS(),
      users,
      widgetMeet
    };
  }
);
