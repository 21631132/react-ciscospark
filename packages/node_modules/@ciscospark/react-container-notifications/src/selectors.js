import {createSelector} from 'reselect';

import {NOTIFICATION_TYPE_CALL, NOTIFICATION_TYPE_POST} from './actions';

const getActivities = (state) => state.conversation.activities; // eslint-disable-line func-style
const getNotifications = (state) => state.notifications.items; // eslint-disable-line func-style
const getAvatars = (state) => state.avatar.get(`items`).toJS(); // eslint-disable-line func-style
const getIncomingCall = (state) => state.media.getIn([`incomingCall`, `call`]);

const getUnsentNotifications = createSelector(
  [getActivities, getNotifications, getAvatars, getIncomingCall],
  (activities, notifications, avatars, incomingCall) =>
    notifications
      .map((notification) => {
        if (notification.type === NOTIFICATION_TYPE_POST) {
          const notificationActivity = findActivityWithUrl(activities, notification.notificationId);
          return Object.assign({}, notification, {
            username: notificationActivity.actor.displayName,
            message: notificationActivity.object.displayName,
            avatar: avatars[notificationActivity.actor.id]
          });
        }
        else if (notification.type === NOTIFICATION_TYPE_CALL) {

          return Object.assign({}, notification, {
            username: incomingCall.from.person.name,
            message: `Incoming Call`,
            avatar: avatars[incomingCall.from.person.id]
          });
        }
        return notification;
      })
);

export default getUnsentNotifications;

function findActivityWithUrl(activities, url) {
  return activities.find((activity) => activity.url === url);
}
