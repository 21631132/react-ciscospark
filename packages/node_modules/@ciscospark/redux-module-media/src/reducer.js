import {fromJS} from 'immutable';

import {
  UPDATE_STATUS,
  UPDATE_CALL_STATE,
  UPDATE_LOCAL_MEDIA,
  UPDATE_REMOTE_MEDIA,
  CALL_CONNECTED,
  CALL_DISCONNECTED,
  STORE_CALL
} from './actions';

export const initialState = fromJS({
  call: null,
  remoteStream: {
    url: null,
    hasAudio: false,
    hasVideo: false
  },
  localStream: {
    url: null,
    sendAudio: true,
    sendVideo: true
  },
  callState: {},
  status: {
    isDialing: false,
    isRinging: false,
    isConnected: false,
    hasSelfView: false
  }
});


// eslint-disable-next-line complexity
export default function reducer(state = initialState, action) {
  switch (action.type) {
  case UPDATE_STATUS:
    return state.mergeIn([`status`], action.payload.status);
  case UPDATE_CALL_STATE: {
    const call = action.payload.call;
    const callState = {
      receivingAudio: call.receivingAudio,
      receivingVideo: call.receivingVideo,
      sendingAudio: call.sendingAudio,
      sendingVideo: call.sendingVideo,
      localAudioDirection: call.localAudioDirection,
      localVideoDirection: call.localVideoDirection,
      remoteMediaStreamUrl: call.remoteMediaStreamUrl,
      localMediaStreamUrl: call.localMediaStreamUrl,
      remoteAudioMuted: call.remoteAudioMuted,
      remoteVideoMuted: call.remoteVideoMuted
    };
    return state.mergeIn([`callState`], callState);
  }
  case UPDATE_LOCAL_MEDIA: {
    const call = action.payload.call;
    const mediaState = {
      localAudioDirection: call.localAudioDirection,
      localVideoDirection: call.localVideoDirection,
      url: call.localMediaStreamUrl
    };
    return state.mergeIn([`localStream`], mediaState);
  }
  case UPDATE_REMOTE_MEDIA: {
    const call = action.payload.call;
    const mediaState = {
      receivingAudio: call.receivingAudio,
      receivingVideo: call.receivingVideo,
      sendingAudio: call.sendingAudio,
      sendingVideo: call.sendingVideo,
      url: call.remoteMediaStreamUrl
    };
    return state.mergeIn([`remoteStream`], mediaState);
  }
  case STORE_CALL:
    return state.set(`call`, action.payload.call);
  case CALL_CONNECTED: {
    const call = action.payload.call;
    return state
      .set(`call`, call)
      .setIn([`status`, `isConnected`], true)
      .setIn([`status`, `isDialing`], false)
      .setIn([`localStream`, `url`], call.localMediaStreamUrl)
      .setIn([`remoteStream`, `url`], call.remoteMediaStreamUrl);
  }
  case CALL_DISCONNECTED: {
    return initialState;
  }
  default:
    return state;
  }
}
